<!DOCTYPE HTML 5>
<html lang="en" dir="ltr">

<head>

    <meta charset='utf-8' />
    <title>Brethren Mennonite Heritage Center Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />
    <link href="nouislider.min.css" rel="stylesheet">
    
    <style>

        body {
          margin: 0;
          padding: 0;
          font-family: 'Helvetica Neue', Helvetica, Arial, Sans-serif;
        }

        #map {
          position: absolute;
          top: 0;
          bottom: 0;
          width: 100%;
        }

        h1 {
          font-size: 20px;
          line-height: 30px;
        }

        h2 {
          font-size: 14px;
          line-height: 20px;
          margin-bottom: 10px;
        }

        a {
          text-decoration: none;
          color: #2dc4b2;
        }
        
        .shortNumber {
            width: 5em;
        }
        
        .field, .shortNumber {
            background-color: transparent;
            border: 1px solid rgba(0, 0, 0, .1);
        }

        #console {
          position: absolute;
          width: 300px;
          margin: 10px;
          padding: 10px 20px;
          background: rgba(230, 255, 250, 0.7);
          border-radius:15px;
          border: 1px solid rgba(0, 0, 0, .1);
        }
        
        .active-year{
          text-align: center;
        }

        .tranche {
          height: 12px;
          width: 100%;
          text-align: center;
          margin-bottom: 20px;
        }
        
        #affiliation {
            background-color: transparent;
        }

        .colors {
          background: linear-gradient(to right, #2dc4b2, #3bb3c3, #669ec4, #8b88b6, #a2719b, #aa5e79);
          margin-bottom: 5px;
        }

        .label {
          width: 15%;
          display: inline-block;
          text-align: center;
        }
        
        .tagClose {
          cursor: pointer;
          position: absolute;
          top: 50%;
          right: 0%;
          padding: 12px 16px;
          transform: translate(0%, -50%);
        }
        
        .mapboxgl-popup {
            max-width: 400px;
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        }
        
        .noUi-target {
          height: 3px;
          border: 0;
          box-shadow: unset;
          background: #cccccc;
          margin: 7px 50px; /* to fend of from membership numbers, and to make shorter than the yearSlider */
        }
        
        .noUi-horizontal .noUi-handle {
          width: 12px;
          right: -6px; /* half of width */
            
          height: 18px;
          top: -9px;  /* half of height */
        }
        
        /* get rid of the pesky || filled shapes (they're not text) */
        .noUi-handle:after,
        .noUi-handle:before {
            content: unset;
        }
        
       #bmhcLogo{
            width:50%;
            margin: 0% 25%;
        }
        
    </style>
    
    <script src="bmhcData.js"></script>
    <script src="bmhcTags.js"></script>
    
</head>

<body id='body'>
    <script src="nouislider.min.js"></script>
    
    <div id='map'></div>
    
    <div id='console'>
        <img id='bmhcLogo' src="BMHC%20Logo%20-%20Color.png" >
        <h2><div id='active-year' class='active-year'>1860</div></h2>
        <div class='tranche' id='sliderbar'>
            <input id='yearSlider' class='tranche' type='range' step='1' />
        </div>
        
        <div class='tranche' id='denomination'>
            <input type="checkbox" id="BrethrenCB" name="Brethren" value = 'brethren' onchange='changeBrethrenCB(this.checked);'>
            <label for='BrethrenCB'>Brethren</label>
            <input type="checkbox" id="MennoniteCB" name="Mennonite" value= 'mennonite' onchange='changeMennoniteCB(this.checked);'>
            <label for='MennoniteCB'>Mennonite</label>
        </div>
        
        <div class='tranche' id='membership'>
            <span><span id='minMembership'>0</span> &leq;&nbsp; membership &nbsp;&leq;&nbsp;<span id='maxMembership'>1000</span></span>
            <div id="maxMinSlider">
            </div> 
        </div>
        <br>
        <div class='tranche' >
            <label for="affiliation">affiliation:</label>
            <select class="field" name="affiliation" id="affiliation"  required="true" onchange="handleAffiliationChange(this.value)">
            </select>
        </div>
        
        <div class='tranche' >
            <label for="addTag">add a tag:</label>
            <select class="field" name="addTag" id="addTag"  required="true" onchange="handleAddTagChange(this.value)">
            </select>
        </div>
        
        <div class='tranche' id="tagFilters" >
        </div>
        
    </div>
    
    <script> //my stuff
        
        var filterBase = new FilterBase();
        
        function maxMembership(){ return 1000;}
        
        function currentYear(){ return new Date().getFullYear();}
    
        function initAffiliationHTML(){
            let str = "";
            //bmhc.getAffiliations().forEach(affiliation => {
            ['any','none','Virginia Conference','MCUSA'].forEach(affiliation => {
                str += '<option value="'+affiliation+'">'+affiliation+'</option>';
            });
            document.getElementById("affiliation").innerHTML = str;
        }
        
        
        function initAddTagHTML() {
            let str = '<option value="none">none</option>';
            bmhcTags().forEach(tag => {
                str += '<option value="'+tag+'">'+tag+'</option>';
            });
            document.getElementById("addTag").innerHTML = str;
        }
        
        function handleAddTagChange(tag) {
            if (tag == 'none') return;
            let str = document.getElementById('tagFilters').innerHTML;
            str += '<button type="button" class="tagFlag" onclick="negateTag(this.value)"> not</button><button type="button" class="tagFlag" onclick="dismissTag(this.value)">&nbsp;'+tag+'&nbsp;&nbsp;&nbsp;x</button><br>';
            document.getElementById("tagFilters").innerHTML = str;
        }
        
        //clobber rightmost bit
        function changeBrethrenCB(checked){
            if (checked) filterBase.mb = filterBase.mb | 1;
            else filterBase.mb = filterBase.mb & 2;
            setMapFilters();
        }
        
        //clobber 2's bit
        function changeMennoniteCB(checked){
            if (checked) filterBase.mb = filterBase.mb | 2;
            else filterBase.mb = filterBase.mb & 1;
            setMapFilters();
        }
        
        function setMapFilters(){
            map.setFilter('assemblyCircles',filterBase.filterSet());
            map.setFilter('assemblyNames',filterBase.filterSet());
        }
        
        function initMaxMinSlider(){
            var mmSlider = document.getElementById('maxMinSlider');
            
            noUiSlider.create(mmSlider, {
                start: [0, maxMembership()],
                connect:true,
                step: 1,
                range: {
                    'min': 0,
                    'max': maxMembership()
                }
            });
        }
        
        //https://www.w3schools.com/howto/howto_js_close_list_items.asp nice formatting
        
        function FilterBase(){
            this.activeYear = Math.round((1700+currentYear())/2)+'/00/00';
            this.mb = 3;
            this.membershipSqrtRange = [ 0, Math.sqrt(maxMembership()) ];
            this.tags = [];
            this.affiliations = []
        }
        
        
        //mb must be absent (in which case it runs off of prior established this.mb),
        //or element of {0,1,2,3}
        FilterBase.prototype.filterDenom = function(mb){
            let ds = [];
            
            if (mb!=undefined)this.mb = mb;
            
            if (this.mb==0) ds.push(['==',['get','denomination'],0]);
            if (this.mb==1 || this.mb == 3) ds.push(['==',['get','denomination'],1]);
            if (this.mb==2 || this.mb == 3) ds.push(['==',['get','denomination'],2]);
            
            return ['any',...ds];
        }
        
        FilterBase.prototype.filterMembership = function(){
            return ['all',
                    ['>=',['get','weight'],this.membershipSqrtRange[0]],
                    ['<=',['get','weight'],this.membershipSqrtRange[1]]
                   ]
        }
        
        //activeYear must be absent (in which case it runs off of prior established this.activeYear)
        //or a date in yyyy, or yyyy/mm, or yyyy/mm/dd
        FilterBase.prototype.filterTime = function(activeYear){
            if (activeYear != undefined) this.activeYear = activeYear+'';
            return ['all',['<=',['get','begin'],this.activeYear],['<',this.activeYear,['get','end']]];
        }
        
        FilterBase.prototype.filterSet = function(){
            //this.filterMembership()];
            //fs.push(this.filterTags()); 
            //fs.push(this.filterAffiliations()); 
            return ['all',this.filterTime(),this.filterDenom(), this.filterMembership()];
        }
       
        
        mapboxgl.accessToken = 'pk.eyJ1IjoiamhuZnJmbGQiLCJhIjoiY2tsbGtvb256MDA2ZzJ2bXB4NXJreHh1YyJ9.m5CZfFB_wUxWs6HIOs3_cg';

        var map = new mapboxgl.Map({
          container: 'map', // container element id
          style: 'mapbox://styles/mapbox/light-v10',
          center: [-79.806421, 37.838214], // initial map center in [lon, lat]
          zoom: 6.9
        });
        
        map.on('load', function() {
            
          map.addSource('assembliesSource', {
            'type': 'geojson',
            'data': './map.geojson'
          });
            
          map.addLayer({
              id: 'assemblyCircles',
              type: 'circle',
              source: 'assembliesSource',
              paint: {
                  'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['number', ['get', 'weight']],
                        0, 3,
                        40, 24
                      ],
                  'circle-color': ['case',['to-boolean',['%',['get','denomination'],2]], '#ff0055', '#00ccff'],
                  'circle-opacity': 0.5
              },
            filter: filterBase.filterSet()
          });
        
          map.addLayer({
              id: 'assemblyNames',
              type: 'symbol',
              source: 'assembliesSource',
              layout: {
                    'text-field': ['get', 'name'],
                    'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
                    'text-radial-offset': 0.5,
                    'text-justify': 'auto'
              },
            filter: filterBase.filterSet()
          });
        
        
            
          //in js console map.getStyle() will show you all the layers, so you can suppress what you don't want
          map.setLayoutProperty('settlement-label', 'visibility', 'none');
          map.setLayoutProperty('poi-label', 'visibility', 'none');
          
    
          let ys = document.getElementById('yearSlider');
          //console.log('ys.value = '+ys.value+ (typeof ys.value) +' '+(typeof ys.min)+' '+(typeof ys.max));
          ys.min = 1700;
          ys.max = currentYear();
          //note can't use (ys.min + ys.max) because these have been magic changed to strings! Dunno how.
          ys.value = Math.round((1700+currentYear())/2); 
          document.getElementById('active-year').innerText = ys.value+'';
          //console.log('  ys.value = '+ys.value+ (typeof ys.value) +' '+(typeof ys.min)+' '+(typeof ys.max));
            
          document.getElementById('yearSlider').addEventListener('input', function(e) {
              document.getElementById('active-year').innerText = e.target.value;
              let activeYear = e.target.value + '/00/00';
              filterBase.filterTime(activeYear);
              setMapFilters();
          });
            

        document.getElementById('maxMinSlider').noUiSlider.on('update', function (values, handle) {
            var mmElements = [
                document.getElementById('minMembership'),
                document.getElementById('maxMembership')
            ];
            mmElements[handle].innerHTML =  Math.round(values[handle]);
            filterBase.membershipSqrtRange[handle] = Math.sqrt(values[handle]);
            setMapFilters();
        });

            
        var popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });

        map.on('mouseenter', 'assemblyCircles', function (e) {
            // Change the cursor style as a UI indicator.
            map.getCanvas().style.cursor = 'pointer';

            var coordinates = e.features[0].geometry.coordinates.slice();
            var name = e.features[0].properties.name;

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            // Populate the popup and set its coordinates
            // based on the feature found.
            popup.setLngLat(coordinates).setHTML(name).addTo(map);
        });

        map.on('mouseleave', 'assemblyCircles', function () {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });
            
        document.getElementById("BrethrenCB").click();
        document.getElementById("MennoniteCB").click();
            
        });
        
        
        initAffiliationHTML();
        initAddTagHTML();
        initMaxMinSlider();
        
        //it's great that these two don't track the movement of the physical key,
        //but the setting and unsetting of the caps lock logic
        document.getElementById('body').addEventListener('keydown', function(e) {
            if (e.getModifierState('CapsLock')) document.getElementById('console').style.display = 'none';
        });
        
        document.getElementById('body').addEventListener('keyup', function(e) {
            if(!e.getModifierState('CapsLock')) document.getElementById('console').style.display = 'block';
        });

    </script>
    
</body>
    

</html>