<!DOCTYPE HTML 5>
<html lang="en" dir="ltr">

<head>

    <meta charset='utf-8' />
    <title>Brethren Mennonite Heritage Center Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />
    
    <style>

        body {
          margin: 0;
          padding: 0;
          font-family: 'Helvetica Neue', Helvetica, Arial, Sans-serif;
        }

        #map {
          position: absolute;
          top: 0;
          bottom: 0;
          width: 100%;
        }

        h1 {
          font-size: 20px;
          line-height: 30px;
        }

        h2 {
          font-size: 14px;
          line-height: 20px;
          margin-bottom: 10px;
        }

        a {
          text-decoration: none;
          color: #2dc4b2;
        }
        
        .shortNumber {
            width: 5em;
        }
        
        .field, .shortNumber {
            background-color: transparent;
            border: 1px solid rgba(0, 0, 0, .1);
        }

        #console {
          position: absolute;
          width: 300px;
          margin: 10px;
          padding: 10px 20px;
          background: rgba(230, 255, 250, 0.7);
          border-radius:15px;
        }
        
        .active-year{
          text-align: center;
        }

        .tranche {
          height: 12px;
          width: 100%;
          text-align: center;
          margin-bottom: 20px;
        }
        
        #affiliation {
            background-color: transparent;
        }

        .colors {
          background: linear-gradient(to right, #2dc4b2, #3bb3c3, #669ec4, #8b88b6, #a2719b, #aa5e79);
          margin-bottom: 5px;
        }

        .label {
          width: 15%;
          display: inline-block;
          text-align: center;
        }
        
        .tagClose {
          cursor: pointer;
          position: absolute;
          top: 50%;
          right: 0%;
          padding: 12px 16px;
          transform: translate(0%, -50%);
        }
        
        .mapboxgl-popup {
            max-width: 400px;
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        }
        
    </style>
    
    <script src="bmhcData.js"></script>
    <script src="bmhcTags.js"></script>
    
</head>

<body>
    
    <div id='map'></div>
    
    <div id='console'>
        <h2><div id='active-year' class='active-year'>1887</div></h2>
        <div class='tranche' id='sliderbar'>
            <input id='slider' class='tranche' type='range' min='1700' max='2050' step='1' value='1887' />
        </div>
        
        <div class='tranche' id='denomination'>
            <input type="checkbox" id="BrethrenCB" name="Brethren" value = 'brethren' onchange='changeBrethrenCB(this.checked);'>
            <label for='BrethrenCB'>Brethren</label>
            <input type="checkbox" id="MennoniteCB" name="Mennonite" value= 'mennonite' onchange='changeMennoniteCB(this.checked);'>
            <label for='MennoniteCB'>Mennonite</label>
        </div>
        
        <div class='tranche' id='membership'>
            <span>
                <input type="number" class="shortNumber" id="minMembership" name="minMembership" min='0' max='99999' dir='rtl' value=0>
                &leq;&nbsp; membership &nbsp;&leq;
                <input type="number" class="shortNumber" id="maxMembership" name="maxMembership"  min='0' max='99999' value=99000>
            </span>
        </div>
        
        <div class='tranche' >
            <label for="affiliation">affiliation:</label>
            <select class="field" name="affiliation" id="affiliation"  required="true" onchange="handleAffiliationChange(this.value)">
            </select>
        </div>
        
        <div class='tranche' >
            <label for="addTag">add a tag:</label>
            <select class="field" name="addTag" id="addTag"  required="true" onchange="handleAddTagChange(this.value)">
            </select>
        </div>
        
        <div class='tranche' id="tagFilters" >
        </div>
        
    </div>
    
    <script> //my stuff
    
        function initAffiliationHTML(){
            let str = "";
            //bmhc.getAffiliations().forEach(affiliation => {
            ['any','none','Virginia Conference','MCUSA'].forEach(affiliation => {
                str += '<option value="'+affiliation+'">'+affiliation+'</option>';
            });
            document.getElementById("affiliation").innerHTML = str;
        }
        
        
        function initAddTagHTML() {
            let str = '<option value="none">none</option>';
            bmhcTags().forEach(tag => {
                str += '<option value="'+tag+'">'+tag+'</option>';
            });
            document.getElementById("addTag").innerHTML = str;
        }
        
        function handleAddTagChange(tag) {
            if (tag == 'none') return;
            let str = document.getElementById('tagFilters').innerHTML;
            str += '<button type="button" class="tagFlag" onclick="negateTag(this.value)"> not</button><button type="button" class="tagFlag" onclick="dismissTag(this.value)">&nbsp;'+tag+'&nbsp;&nbsp;&nbsp;x</button><br>';
            document.getElementById("tagFilters").innerHTML = str;
        }
        
        
        initAffiliationHTML();
        initAddTagHTML();
        
        //https://www.w3schools.com/howto/howto_js_close_list_items.asp nice formatting
    </script>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiamhuZnJmbGQiLCJhIjoiY2tsbGtvb256MDA2ZzJ2bXB4NXJreHh1YyJ9.m5CZfFB_wUxWs6HIOs3_cg';

        var map = new mapboxgl.Map({
          container: 'map', // container element id
          style: 'mapbox://styles/mapbox/light-v10',
          center: [-79.806421, 37.838214], // initial map center in [lon, lat]
          zoom: 6.9
        });
        
        var aTag = 'paid minister'; 
        
        var activeYear = '1887/00/00';
        var filterTime = ['all',['<=',['get','begin'],activeYear],['<',activeYear,['get','end']]];
        var filterDenom =['any',['==',['get','denomination'],1],['==',['get','denomination'],2]];
        var filterTags = ['in',aTag,['get','tags']];
        
        function filterSet(){ 
            return filterTime; //['all',filterTime,filterTags];
        }
        
        map.on('load', function() {
            
          map.addSource('assembliesSource', {
            'type': 'geojson',
            'data': './map.geojson'
          });
            
          map.addLayer({
              id: 'assemblyCircles',
              type: 'circle',
              source: 'assembliesSource',
              paint: {
                  'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['number', ['get', 'weight']],
                        0, 3,
                        800, 24
                      ],
                  'circle-color': '#118800',
                  'circle-opacity': 0.5
              },
            filter: filterSet()
          });
        
          map.addLayer({
              id: 'assemblyNames',
              type: 'symbol',
              source: 'assembliesSource',
              layout: {
                    'text-field': ['get', 'name'],
                    'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
                    'text-radial-offset': 0.5,
                    'text-justify': 'auto'
              },
            filter: filterSet()
          });
        
        
            
          //in js console map.getStyle() will show you all the layers, so you can suppress what you don't want
          map.setLayoutProperty('settlement-label', 'visibility', 'none');
          map.setLayoutProperty('poi-label', 'visibility', 'none');
          
            
          document.getElementById('slider').max = String(new Date().getFullYear());
          
            
          document.getElementById('slider').addEventListener('input', function(e) {
              document.getElementById('active-year').innerText = e.target.value;
              activeYear = e.target.value + '/00/00';
              filterTime = ['all',['<=',['get','begin'],activeYear],['<',activeYear,['get','end']]];
              map.setFilter('assemblyCircles',filterSet());
              map.setFilter('assemblyNames',filterSet());
          });
            
        var popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });

        map.on('mouseenter', 'assemblyCircles', function (e) {
            // Change the cursor style as a UI indicator.
            map.getCanvas().style.cursor = 'pointer';

            var coordinates = e.features[0].geometry.coordinates.slice();
            var name = e.features[0].properties.name;

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            // Populate the popup and set its coordinates
            // based on the feature found.
            popup.setLngLat(coordinates).setHTML(name).addTo(map);
        });

        map.on('mouseleave', 'assemblyCircles', function () {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });
            
        });

    </script>
    
</body>
    

</html>