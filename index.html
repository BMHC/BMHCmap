<!DOCTYPE html>
<html lang="en" dir="ltr">
    
<!--
index1.html
Copyright 2021 John R C Fairfield, see MIT license

https://stackoverflow.com/questions/4130237/displaying-crosshairs-in-the-center-of-a-javascript-google-map

<div><a href="url to google drive of help documentation" target="_blank" float="right">help manual</a></div>

-->

<head>
<meta charset="utf8">
    <!--
<link rel="stylesheet" href="https://www.w3.org/StyleSheets/TR/2016/base.css">
<link rel="stylesheet" href="../css/core.css">
<script src="../js/examples.js"></script>
<script src="../js/highlight.pack.js"></script>
<script src="../js/app.js"></script>
<script src="../js/utils.js" type="text/javascript"></script>

<link href="css/listbox.css" rel="stylesheet">
<script src="js/listbox.js" type="text/javascript"></script>
<script src="js/toolbar.js" type="text/javascript"></script>
<script src="js/main.js" type="text/javascript"></script>
    -->
<style>
  
    body {
        font-size:medium;
        font-family: 'Times New Roman', serif;
        background-color:#faf0e6; /*linen is #faf0e6. Or rgb(230,255, 220) is a light green;*/
    }

    input{
        font-family:'Times New Roman', serif;
    }
    
    .container {
        padding:0px 20px;
    }

    .textButton {
        padding: 4px 0px;
        border: none;
        font-family: 'Times New Roman', serif;
        background-color:#fffaf0;
    }
    
    .monotype {
        font-family:'Monaco';
        font-size:12px;
    }
/*
    .title {
        box-sizing: border-box;
        padding: 16px 0px;
    }
*/    
    #ss_elem_list, #inputAssemblyName, #changingAssemblyName {
        background-color:#d0efd0;
    }

  
</style>
    
<link rel="stylesheet" href="listbox/css/listbox.css">
<script src="listbox/js/listbox.js" type="text/javascript"></script>
<script src="listbox/js/listbox-scrollable.js" type="text/javascript"></script>   
<script src="listbox/js/utils.js" type="text/javascript"></script>

    
<script src="BMHC.js"></script>
    
</head>
    
<body>
   <div class="container">
        <div class="title">
            <scan id="test" style="white-space: break-spaces;">Brethren Mennonite Heritage Center</scan>
            
<!-- strategy for making sure that for assembly names or in event objects or notes
  whatever the user types (including accidental html-interpreted symbols) 
  is what they see (save trimming blanks from the ends) 
  and what is saved in the db:
     use "white-space: break-spaces;", 
     and get values from inputs, or innerText (not innerHTML) from divs and scans etc.,
     and set innerText (not innerHTML) of divs and scans etc.
     AND use a constant character width font, so that extra blanks are clearly perceptible.
  The "test" field above was used from javascript console to try out this sort of thing.
-->
            <h3>Map data editor</h3>
        </div>
       
        <div id="midscreen">
            
            <div id=assemblyViewer><b>1. Assembly List</b></div>
            
            <div id=assemblyCreator><b>2. Create an Assembly</b></div>
            
            <div id=assemblyEditor><b>3. Edit an Assembly</b></div>
            
            <div id="eventViewer">
                <b>4. Event list for:&nbsp;<span id="eventsAssemblyName" style="white-space: break-spaces;"></span></b>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <button type="button" onclick="initAssemblyViewer()">back to Assembly List</button>
            </div>
            
            <div id="eventEditor">
                <b>5. Event Editor for:&nbsp;<span id="eventsAssemblyName" style="white-space: break-spaces;"></span></b>
            </div>
            
            <div id="checkboxen">
                <input type="checkbox" id="BrethrenCB" name="Brethren" onchange='changeBrethrenCB(this.checked);'>
                <label for="bro">Brethren</label>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <input type="checkbox" id="MennoniteCB" name="Mennonite" onchange='changeMennoniteCB(this.checked);'>
                <label for="menno">Mennonite</label>
                <br>
                <br>
            </div>

            <div id="assemblyInstructions">
                <button id="createAssembly" class="textButton" onclick="launchNewAssembly()">Click here to create a new assembly.</button>
                <br> Or select an assembly (by clicking in the green, then use arrow keys or start typing its name)
                <br> and hit <em>enter</em> (<em>return</em>) to view and edit its events,
                <br> or <em>space</em> to change its name or denomination,
                <br> or <em>delete</em> (or <em>backspace</em>) to delete it.
                <br>
            </div> 

            <div id="newAssembly">
                <scan id="assemblyNamePrompt">Enter a unique assembly name: </scan>
                <br>
                <input type="text" id="inputAssemblyName" style="white-space: break-spaces;" size=70>
                <br>
                <button type="button" onclick="initAssemblyViewer()">cancel</button>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <button type="button" onclick="saveAssembly()">save</button> 
            </div>
            
            <div id="changeAssembly">
                <scan id="changeAssemblyPrompt">Change its denomination or name: </scan>
                <br>
                <input type="text" id="changingAssemblyName" style="white-space: break-spaces;" size=70>
                <br>
                <button type="button" onclick="initAssemblyViewer()">cancel</button>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <button type="button" onclick="changeAssembly()">change</button>
            </div>
            
            
            <div id="eventInstructions">
                <br>
                <button class="textButton" onclick="launchEditEvent()">Click here to create a new event. </button>
                <br> Or select a listed event 
                <br> and hit <em>space</em> to change it,
                <br> or <em>delete</em> (or <em>backspace</em>) to delete it.
                <br>
            </div> 
            
            
            <div id="eventForm">
                <br>
                <label for="eventDate">date (yyyy/mm/dd):</label>
                  <input type="text" id="eventDate" size=8 >
                <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <label for="eventVerb">verb:</label>
                <select name="eventVerb" id="eventVerb"  required="true">
                </select>
                <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <label>object:</label>
                <input type="text" id="eventObject" size=70 >
                <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <label>note:</label>
                <textarea type="text" id="eventNote" rows=3 cols=60> </textarea>
                <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <button type="button" onclick="initEventViewer()">cancel</button>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <button type="button" onclick="checkAndSaveEvent()">save</button>
            </div>
           
            <div id="stateOfEvents">
                <br>
                date: 1925
                <br>
                locale: 38.377180983452404, -79.03095281203223 1915 note: College Ave church
                <br>
                weight: 521 1925
                <br>
                affiliation: 2nd District of Virginia 1907 note: "Bridgewater" becomes independent from "Cooks Creek".
                labels: salaried pastor, sunday school
            </div>
       </div> <!-- end of midscreen -->
       
        <!--<div class="listbox-area" > -->
        <div id="myListbox">
            <div class="all-area">
                <ul id="ss_elem_list"
                    tabindex="0"
                    role="listbox"
                    aria-labelledby="ss_elem"
                    style="white-space: break-spaces;">
            <!--    onclick ="whatever();"> <!--onselect, onchange don't work -->
                </ul>
            </div>  
        </div>

    </div>
    
<script>

//globals
    
const divCaches = {
    assemblyViewer:"",
    assemblyCreator:"",
    assemblyEditor:"",
    eventViewer:"",
    eventEditor:"",
    assemblyInstructions:"",
    checkboxen:"",
    newAssembly:"",
    changeAssembly:"",
    eventInstructions:"",
    eventForm:"",
    stateOfEvents:""
}

const midscreenTypes = {
    assemblyInstructions:["assemblyViewer","checkboxen","assemblyInstructions"], 
    newAssembly:["assemblyCreator","checkboxen","newAssembly"],
    changeAssembly:["assemblyEditor","checkboxen","changeAssembly"],
    eventInstructions:["eventViewer","eventInstructions"],
    editEvent:["eventEditor","eventForm"], 
    stateOfEvents:["eventViewer","stateOfEvents"],
}

//state
//   checkbox 0: assemblies that are neither B nor M, 1 B, 2 M, 3 both
//   whichList "assemblies" or "events"
//   priorAssemblyName target of event editing
//   eventIndex index of event being edited or deleted, valid only after a getEventList
//   hasn't been invalidated by a deleteEvent or addEvent (in which case, just need to redo getEventList).

let state = {checkbox:1, whichList:"assemblies", priorAssemblyName:"", eventIndex:null };

let bmhc =  BMHCobj();
    
// Of general utility:
    
    
function formatMidscreen(screenType){ //see midScreenTypes
    
    function setCheckboxen() { //0: neither checked, 1 Brethren, 2 Mennonite, 3 both
        if (document.getElementById("BrethrenCB") != null) document.getElementById("BrethrenCB").checked =(state.checkbox == 1 || state.checkbox == 3);
        if (document.getElementById("MennoniteCB") != null) document.getElementById("MennoniteCB").checked = (state.checkbox == 2 || state.checkbox == 3);
    }
    
    let htmlStr = "";
    midscreenTypes[screenType].forEach(item => htmlStr+=divCaches[item]);
    document.getElementById("midscreen").innerHTML = htmlStr;
    setCheckboxen(); 
}


function cacheDivs(){
    Object.keys(divCaches).forEach(key => {
        divCaches[key] = document.getElementById(key).innerHTML.slice();
    });
}

function setVerbHTML(){
    let str = "";
    bmhc.getVerbs().forEach(verb => {
        str += '<option value="'+verb+'">'+verb+'</option>';
    });
    document.getElementById("eventVerb").innerHTML = str;
}
    
function makeLIsOfArray(arr){
    let result = "";
    
    function makeli(i) {
      return "<li id=\"xyzzy"+i+"\" role=\"option\" class=\"monotype\"></li>";
    }
    
    arr.forEach((item,i)=>{result+=makeli(i);});
    
    document.getElementById("ss_elem_list").innerHTML = result; //build them first, so you can innerText them.
    
    arr.forEach((item,i)=> {document.getElementById("xyzzy"+i).innerText = item;});
    
}
    
//Assembly viewer, screenType 0:
    
function initAssemblyViewer(){ 
    state.whichList = "assemblies";
    formatMidscreen("assemblyInstructions");
    setAssemblyListboxInnerHTML();
    document.getElementById("myListbox").style.visibility='visible';
}
    
function setAssemblyListboxInnerHTML(){
    var items = [];
    
    if (state.checkbox == 0) items = bmhc.getNeitherAssemblyNames();
    else if (state.checkbox == 1) items = bmhc.getBrethrenAssemblyNames();
    else if (state.checkbox == 2) items = bmhc.getMennoniteAssemblyNames();
    else items = bmhc.getJointAssemblyNames();
    
    makeLIsOfArray(items);
}

function changeBrethrenCB(checked){
    if (checked) state.checkbox = state.checkbox | 1;
    else state.checkbox = state.checkbox & 0xfffffe;  //...11110
    setAssemblyNamePrompt();
    setAssemblyListboxInnerHTML();
}
    
function changeMennoniteCB(checked){
    if (checked) state.checkbox = state.checkbox | 2;
    else state.checkbox = state.checkbox & 0xfffffd;  //...11101
    setAssemblyNamePrompt();
    setAssemblyListboxInnerHTML();
}

    /*
function listKeyPress(that, event){
    //console.log(event.shiftKey, event.altKey, event.ctrlKey, event.metaKey);
    //console.log(that.getAttributeNode("aria-activedescendant").value); //the id of selected item
    //console.log(that); //<ul id="ss_elem_list"...
    //console.log(event); //if event.key == "Enter" or.charCode: 13 (what is it on pc?)
    if (event.charCode == 13){
        var lineId = that.getAttributeNode("aria-activedescendant").value;
        var elementText = document.getElementById(lineId).innerText; //NOT innerHTML
        initEventViewer(elementText);
    } 
}   */


//onclick only responds to mouse click, not to movement of selection through typing prefixen
//or arrowUp arrowDn. Perhaps can use "return" key event to drive selection after movement.
function initEventViewer(assemblyName){
    
    if (assemblyName == null) assemblyName = state.priorAssemblyName;
    else state.priorAssemblyName = assemblyName;
    
    state.whichList = "events";
    formatMidscreen("eventInstructions");
    document.getElementById("eventsAssemblyName").innerText = assemblyName;
    makeLIsOfArray(bmhc.getEventStrings(assemblyName));
    document.getElementById("myListbox").style.visibility='visible';
    //console.log(ss_elem_list.getAttribute('aria-activedescendant')); //dom not updated yet, reflects previous value
}
function initAssemblyViewer(){ 
    state.whichList = "assemblies";
    formatMidscreen("assemblyInstructions");
    setAssemblyListboxInnerHTML();
    document.getElementById("myListbox").style.visibility='visible';
}

// Assembly editing, screenType 1
// document.getElementById("ss_elem_list").getAttributeNode("aria-activedescendant").value
    
function setAssemblyNamePrompt(){
    var denom;
    if (!document.getElementById("assemblyNamePrompt"))return;
    
    switch (state.checkbox){
        case 0: denom = "denominationless"; break;
        case 1: denom = "Brethren"; break;
        case 2: denom = "Mennonite"; break;
        case 3: denom = "both Mennonite and Brethren"; break;
    }
    document.getElementById("assemblyNamePrompt").innerHTML = "Enter a new assembly name ("+denom+"):";
}

function launchNewAssembly(name){
    formatMidscreen("newAssembly");
    setAssemblyNamePrompt();
    if (name && name.length)document.getElementById("inputAssemblyName").value = name;
    document.getElementById("myListbox").style.visibility='hidden';
}
    
function saveAssembly(){
    const assemblyName = document.getElementById("inputAssemblyName").value;
    const returnMsg = bmhc.addAssembly(assemblyName,state.checkbox);
    if (returnMsg != "ok") alert(returnMsg);
    else initAssemblyViewer();
}

function launchChangeAssembly(name){
    state.priorAssemblyName = name; //cache it for changeAssembly
    state.checkbox = bmhc.getDenomination(name);
    formatMidscreen("changeAssembly");
    document.getElementById("changingAssemblyName").value = name;
    document.getElementById("myListbox").style.visibility='hidden';
}
    
function changeAssembly(){
    const assemblyName = document.getElementById("changingAssemblyName").value.trim();
    const returnMsg = bmhc.changeAssembly(state.priorAssemblyName,assemblyName, state.checkbox);
    console.log(returnMsg);
    if (returnMsg != "ok") alert(returnMsg);
    else initAssemblyViewer();
}
    
function deleteAssembly(name){
    let refCount = 0;
    if (!bmhc.assemblyExists(name)) alert("This assembly doesn't exist.")
    else{
        if (confirm("This will also delete all events of this assembly, and remove all references to this assembly in other event affiliations or notes. OK?")){
            refCount = bmhc.deleteAssembly(name);
            if (refCount) alert(refCount+" references removed.");
            initAssemblyViewer();
        }
    }
}

//    ------------------------------------- event screens --------------------- 
    
// for installEventListener the word 'event' refers to window keydown events, not to assembly events!    
function installEventListener(){
    document.getElementById('ss_elem_list').addEventListener('keydown', function(event) { 
        const itemId = document.getElementById('ss_elem_list').getAttributeNode("aria-activedescendant").value;
        const item = document.getElementById(itemId).innerText; //NOT innerHTML

        if(state.whichList === 'assemblies'){
            //item is an assembly name
            if (event.key === 'Backspace' || event.key === 'Delete') { 
                event.preventDefault();
                deleteAssembly(item);
            } else if (event.key === ' ' || event.key === 'Spacebar'){
                event.preventDefault();
                launchChangeAssembly(item);
            } else if (event.key === 'Enter'){
                event.preventDefault();
                initEventViewer(item);
            }
        } else if (state.whichList === 'events') { 
            const index = parseInt(itemId.slice(5)); //remove the xyzzy
            if (event.key === 'Backspace' || event.key === 'Delete') { 
                event.preventDefault();
                bmhc.deleteEvent(state.priorAssemblyName,index);
                initEventViewer();
            } else if (event.key === ' ' || event.key === 'Spacebar'){
                event.preventDefault();
                launchEditEvent(index);
            }
        }
    })
}

   
function launchEditEvent(eventIndex){
    state.eventIndex = eventIndex; //if null means it's a new event to be added
    formatMidscreen("editEvent");
    setVerbHTML();
    document.getElementById("myListbox").style.visibility='visible';
    
    if (eventIndex == null) setEventFields("","","","");
    else {
        let ev = bmhc.getEvent(state.priorAssemblyName,eventIndex);
        setEventFields(ev.date, ev.verb, ev.object, ev.note);
    }
}
    
function setEventFields(date,verb,obj,note){
    document.getElementById("eventDate").value = date;
    document.getElementById("eventVerb").value = verb;
    document.getElementById("eventObject").value = obj;
    document.getElementById("eventNote").value = note;
}
    
function checkAndSaveEvent(){
    const date = document.getElementById("eventDate").value;
    const verb = document.getElementById("eventVerb").value;
    const obj  = document.getElementById("eventObject").value;
    const note = document.getElementById("eventNote").value;
    
    const result = bmhc.addEvent(state.priorAssemblyName,date,verb,obj,note,false); //just checking, won't add
    if (result != 'ok') { alert(result);} //and do nothing, stay put
    else {
        bmhc.deleteEvent(state.priorAssemblyName,state.eventIndex); // if eventIndex is null, does nothing
        bmhc.addEvent(state.priorAssemblyName,date,verb,obj,note,true); //do it this time
        setEventFields('','','',''); //and stay put, ready to add another
    }
}

function ultest(){
    var ul = document.getElementById('ss_elem_list');
    ul.onclick = function(event) {
        alert(event.target.innerText);
    };
}
    
cacheDivs();
installEventListener();                     
initAssemblyViewer();
    
</script>

</body>