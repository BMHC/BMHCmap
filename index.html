<!DOCTYPE HTML 5>
<html lang="en" dir="ltr">
    
<!--
index1.html
Copyright 2021 John R C Fairfield, see MIT license

https://stackoverflow.com/questions/4130237/displaying-crosshairs-in-the-center-of-a-javascript-google-map

<div><a href="url to google drive of help documentation" target="_blank" float="right">help manual</a></div>

-->

<head>
<meta charset="utf8">
  
<style>
  
    body {
        font-size:medium;
        font-family: 'Times New Roman', serif;
        background-color:#faf0e6; /*linen is #faf0e6. Or rgb(230,255, 220) is a light green;*/
    }

    input{
        font-family:'Times New Roman', serif;
    }
    
    .container {
        padding:0px 20px;
    }

    .textButton {
        padding: 4px 1px;
        border: none;
        font-family: 'Times New Roman', serif;
        font-size:medium;
        background-color:#fffaf0;
    }
    
    .monotype {
        font-family:'Monaco';
        font-size:12px;
    }
    
    .d-table {
      display:flex;
    }

    .d-table div {
      flex: 1;
    }

    .tar {
      text-align: right;
    }
    
    .load-save{
        font-size: 14px;
    }
    
    #selectList, #inputAssemblyName, #changingAssemblyName, #eventsAssemblyName, #eventAssemblyName {
        background-color:#d0efd0;
        white-space: break-spaces;
    }
    
    #selectList {
        margin:8px 0px 0px 0px;
        padding:2px 4px;
        width: 100%;
        height: 23em;
    }

    
    /* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 88px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,50,0); /* Fallback color */
  background-color: rgba(0,50,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
  background-color: #fefefe;
  margin: auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
}

/* The Close Button */
.close {
  color: #aaaaaa;
  float: right;
  font-size: 32px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}

.sotto{
  color: #888;
}
  
</style>

<script src="bmhcData.js"></script>
<script src="bmhcTags.js"></script>
<script src="bmhc.js"></script>
    
</head>
    
<body>

   <div class="container">
       
       <div id="header">
                <div class="d-table" >
                    <div style="height:80px;" >
                        Brethren Mennonite Heritage Center
                        <br>
                        <br> <span STYLE="font-size:x-large"><b>Map data editor</b></span>
                        <br><span STYLE="font-size:x-small; color:#b0b0b0;">version 0.5 2021 John Fairfield</span>
                    </div>
                    <div class="tar">
                        <button type="button" class='load-save' onclick='saveData()'>Save database</button> <br>
                        <a download="bmhcData.js" id="downloadlink" style="visibility: hidden" onclick='makeMeDisappear(this)'>OK to download?</a>
                    </div>
                </div>
                <hr>
           </div>
       
        <div id="midscreen">

            <div id="assemblyViewer" ><b>Page 1. Assembly List</b><br></div>
            
            <div id="assemblyCreator" ><b>Create an Assembly</b><br></div>
            
            <div id="assemblyEditor" ><b>Edit an Assembly</b><br></div>
     
            <div id="eventViewer">
                <b>Page 2. Event list for:&nbsp;<span id="eventsAssemblyName"></span><br></b>
            </div>
            
            
            <div id="checkboxen">
                <input type="checkbox" id="BrethrenCB" name="Brethren" onchange='changeBrethrenCB(this.checked);'>
                Brethren
                &nbsp;&nbsp;&nbsp;&nbsp;
                <input type="checkbox" id="MennoniteCB" name="Mennonite" onchange='changeMennoniteCB(this.checked);'>
                Mennonite
                <br>
            </div>

            <div id="assemblyInstructions">
                <button id="createAssembly" class="textButton" onclick="launchNewAssembly()">Click here to create a new assembly.</button>
                <br> Or select an assembly <span class="sotto">(by clicking on it, or use arrow keys or start typing its name)</span>
                <br> and hit <em>delete</em> to delete it <span class="sotto">(<em>backspace</em> also works),</span>
                <br> or double click to edit it <span class="sotto">(hitting the space bar also works),</span>
                <br>
                <br> OR, hit <em>return</em> to view its events <span class="sotto">(<em>enter</em> also works).</span>
            </div>
            
<!-- strategy for making sure that for assembly names or in event objects or comments
  whatever the user types (including accidental html-interpreted symbols) 
  is what they see (save trimming blanks from the ends) 
  and what is saved in the db:
     use "white-space: break-spaces;", 
     and get values from inputs, or innerText (not innerHTML) from divs and scans etc.,
     and set innerText (not innerHTML) of divs and scans etc.
     AND use a constant character width font, so that extra blanks are clearly perceptible.
-->

            <div id="newAssembly">
                <scan id="assemblyNamePrompt">Enter a unique assembly name: </scan>
                <br>
                <input type="text" id="inputAssemblyName" size=70>
                <br>
                <button type="button" onclick="initAssemblyViewer()">&#10094; cancel</button>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <button type="button" onclick="saveAssembly()">save</button> 
            </div>
            
            <div id="changeAssembly">
                <scan id="changeAssemblyPrompt">Change its denomination (above) or name (below): </scan>
                <br>
                <input type="text" id="changingAssemblyName" size=70>
                <br>
                <button type="button" onclick="initAssemblyViewer()">&#10094; cancel</button>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <button type="button" onclick="changeAssembly()">change</button>
            </div>
            
            
            <div id="eventInstructions">
                <br>
                <button class="textButton" onclick="launchEditEvent(null)">Click here to create a new event. </button>
                <br> Or select a listed event <span class="sotto">(by clicking on it, or use arrow keys or start typing its date)</span>
                <br> and hit <em>delete</em> to delete it <span class="sotto">(<em>backspace</em> also works),</span>
                <br> or double click to edit it <span class="sotto">(hitting the space bar also works),</span>
                <br>
                <br><button type="button" class="load-save" onclick="initAssemblyViewer()">&#10094; OR, go back to Page 1.</button>
                <br>
            </div> 
            
            <div id="eventEditor" class="modal">
                <div class="modal-Content">
                    <span class="close" onclick="initEventViewer()">&times;</span>
                    <b>Event Editor for:&nbsp;<span id="eventAssemblyName" ></span></b>
                    <br>
                    <label for="eventDate">date (yyyy/mm/dd):</label>
                      <input type="text" id="eventDate" size=8 >
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <label for="eventVerb">verb:</label>
                    <select name="eventVerb" id="eventVerb"  required="true" onchange="handleVerbChange(this.value)">
                    </select>
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <label>object:</label>
                    <input type="text" id="eventObject" size="58" >
                    <select name="eventTagObject" id="eventTagObject" required="true" onchange="handleTagSelection(this.value)"></select>
                    <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <label>comment:</label>
                    <textarea type="text" id="eventComment" rows=2 cols=50> </textarea>
                    <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button type="button" onclick="initEventViewer()">&#10094; cancel</button>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button type="button" onclick="checkAndSaveEvent()">save</button>
                </div>
            </div>
            
       </div> <!-- end of midscreen -->
       
       <div id="myListbox">
           <select id="selectList" size="18">
           </select>
       </div>
       
    </div>
    
<script>

//globals
    
const switchDivs = [
    'assemblyViewer',
    'assemblyCreator',
    'assemblyEditor',
    'eventViewer',
    'eventEditor',
    'assemblyInstructions',
    'checkboxen',
    'newAssembly',
    'changeAssembly',
    'eventInstructions'
]

const midscreenTypes = {
    assemblyInstructions:["assemblyViewer","checkboxen","assemblyInstructions"], 
    newAssembly:["assemblyCreator","checkboxen","newAssembly"],
    changeAssembly:["assemblyEditor","checkboxen","changeAssembly"],
    eventInstructions:["eventViewer","eventInstructions"],
    editEvent:["eventViewer","eventInstructions","eventEditor"]
}

 
// Of general utility:
    
function formatMidscreen(screenType){ //see midScreenTypes
    
        function setCheckboxen() { //0: neither checked, 1 Brethren, 2 Mennonite, 3 both
            if (document.getElementById("BrethrenCB") != null) document.getElementById("BrethrenCB").checked =(state.checkbox == 1 || state.checkbox == 3);
            if (document.getElementById("MennoniteCB") != null) document.getElementById("MennoniteCB").checked = (state.checkbox == 2 || state.checkbox == 3);
        }
    
    switchDivs.forEach(div => document.getElementById(div).style.display='none'); //clear them all
    midscreenTypes[screenType].forEach(div => document.getElementById(div).style.display='block');
    setCheckboxen(); 
}

    
function initVerbHTML(){
    let str = "";
    bmhc.getVerbs().forEach(verb => {
        str += '<option value="'+verb+'">'+verb+'</option>';
    });
    document.getElementById("eventVerb").innerHTML = str;
}
    
function initEventTagObjectHTML() {
    let str = "";
    bmhc.getTags().forEach(tag => {
        str += '<option value="'+tag+'">'+tag+'</option>';
    });
    document.getElementById("eventTagObject").innerHTML = str;
}

function handleVerbChange(verb) {
    if(verb == 'add-tag' || verb == 'remove-tag'){
        document.getElementById("eventTagObject").style.display = 'inline';
        document.getElementById("eventObject").style.display = 'none';
        handleTagSelection(document.getElementById('eventTagObject').value);
    } else {
        document.getElementById("eventTagObject").style.display = 'none';
        document.getElementById("eventObject").style.display = 'inline';
    }
}
    
function handleTagSelection(tag){
    document.getElementById('eventObject').value = tag; //because eventObject is what is passed to db, not eventTagObject.
}

    
function makeLIsOfArray(arr){
    let result = "";
    
    function makeli(i) {
      return "<option id=\"xyzzy"+i+"\" class=\"monotype\"></option>";
    }
    
    arr.forEach((item,i)=>{result+=makeli(i);});
    
    document.getElementById("selectList").innerHTML = result; //build them first, so you can innerText them.
    
    arr.forEach((item,i)=> {
        document.getElementById("xyzzy"+i).innerText = item;
        document.getElementById("xyzzy"+i).value = item;
    });
    
}
    
//Assembly viewer, screenType 0:
    
function initAssemblyViewer(){ 
    state.whichList = "assemblies";
    formatMidscreen("assemblyInstructions");
    setAssemblyListboxInnerHTML();
    document.getElementById("myListbox").style.visibility='visible';
    
    document.getElementById("selectList").focus();
}
    
function setAssemblyListboxInnerHTML(){
    var items = [];
    
    if (state.checkbox == 0) items = bmhc.getNeitherAssemblyNames();
    else if (state.checkbox == 1) items = bmhc.getBrethrenAssemblyNames();
    else if (state.checkbox == 2) items = bmhc.getMennoniteAssemblyNames();
    else items = bmhc.getJointAssemblyNames();
    
    makeLIsOfArray(items);

}

function changeBrethrenCB(checked){
    if (checked) state.checkbox = state.checkbox | 1;
    else state.checkbox = state.checkbox & 0xfffffe;  //...11110
    setAssemblyNamePrompt();
    initAssemblyViewer();
}
    
function changeMennoniteCB(checked){
    if (checked) state.checkbox = state.checkbox | 2;
    else state.checkbox = state.checkbox & 0xfffffd;  //...11101
    setAssemblyNamePrompt();
    initAssemblyViewer();
}

//onclick only responds to mouse click, not to movement of selection through typing prefixen
//or arrowUp arrowDn. Perhaps can use "return" key event to drive selection after movement.
function initEventViewer(assemblyName){
    
    if (assemblyName == null) assemblyName = state.priorAssemblyName;
    else state.priorAssemblyName = assemblyName;
    
    state.whichList = "events";
    formatMidscreen("eventInstructions");
    document.getElementById("eventsAssemblyName").innerText = assemblyName;
    makeLIsOfArray(bmhc.getEventStrings(assemblyName));
    document.getElementById("myListbox").style.visibility='visible';
    state.eventIndex = null; //clear it
    
    document.getElementById("selectList").focus();
}

// Assembly editing, screenType 1
// document.getElementById("ss_elem_list").getAttributeNode("aria-activedescendant").value
    
function setAssemblyNamePrompt(){
    var denom;
    if (!document.getElementById("assemblyNamePrompt"))return;
    
    switch (state.checkbox){
        case 0: denom = "denominationless"; break;
        case 1: denom = "Brethren"; break;
        case 2: denom = "Mennonite"; break;
        case 3: denom = "both Mennonite and Brethren"; break;
    }
    document.getElementById("assemblyNamePrompt").innerHTML = "Enter a new assembly name ("+denom+"):";
}

function launchNewAssembly(name=''){
    formatMidscreen("newAssembly");
    setAssemblyNamePrompt();
    document.getElementById("inputAssemblyName").value = name;
    document.getElementById("myListbox").style.visibility='hidden';
}
    
function saveAssembly(){
    const assemblyName = document.getElementById("inputAssemblyName").value;
    const returnMsg = bmhc.addAssembly(assemblyName,state.checkbox);
    if (returnMsg != "ok") alert(returnMsg);
    else initAssemblyViewer();
}

function launchChangeAssembly(name){
    state.priorAssemblyName = name; //cache it for changeAssembly
    state.checkbox = bmhc.getDenomination(name);
    formatMidscreen("changeAssembly");
    document.getElementById("changingAssemblyName").value = name;
    document.getElementById("myListbox").style.visibility='hidden';
}
    
function changeAssembly(){
    const assemblyName = document.getElementById("changingAssemblyName").value.trim();
    const returnMsg = bmhc.changeAssembly(state.priorAssemblyName,assemblyName, state.checkbox);
    if (returnMsg != "ok") alert(returnMsg);
    else initAssemblyViewer();
}
    
function deleteAssembly(name){
    let refCount = 0;
    if (!bmhc.assemblyExists(name)) alert("This assembly doesn't exist.")
    else{
        if (confirm("This will also delete all events of this assembly, and remove all references to this assembly in other event affiliations or comments. OK?")){
            refCount = bmhc.deleteAssembly(name);
            if (refCount) alert(refCount+" references removed.");
            initAssemblyViewer();
        }
    }
}

//    ------------------------------------- event screens --------------------- 
    
// for installEventListeners the word 'event' refers to window keydown events, not to assembly events!    
function installEventListeners(){
    document.getElementById('selectList').addEventListener('keydown', function(event) { 
        var sL = document.getElementById("selectList");
        
        if (sL.selectedIndex >= 0){
            if(state.whichList === 'assemblies'){
                var assyName=sL.options[sL.selectedIndex].value;
                if (event.key === 'Backspace' || event.key === 'Delete') { 
                    event.preventDefault();
                    deleteAssembly(assyName);
                } else if (event.key === ' ' || event.key === 'Spacebar'){
                    event.preventDefault();
                    launchChangeAssembly(assyName);
                } else if (event.key === 'Enter'){
                    event.preventDefault();
                    initEventViewer(assyName);
                }
            } else if (state.whichList === 'events') { 
                //const index = parseInt(itemId.slice(5)); //remove the xyzzy

                if (event.key === 'Backspace' || event.key === 'Delete') { 
                    event.preventDefault();
                    bmhc.deleteEvent(state.priorAssemblyName,sL.selectedIndex);
                    initEventViewer();
                } else if (event.key === ' ' || event.key === 'Spacebar'){
                    event.preventDefault();
                    launchEditEvent(sL.selectedIndex);
                }
            }
        }
    });
    
    document.getElementById('selectList').addEventListener('dblclick', function(event) {
        var sL = document.getElementById("selectList");
        
        if (sL.selectedIndex >= 0){
            if(state.whichList === 'assemblies'){
                var assyName=sL.options[sL.selectedIndex].value;
                event.preventDefault();
                launchChangeAssembly(assyName);
            } else if (state.whichList === 'events') { 
                event.preventDefault();
                launchEditEvent(sL.selectedIndex);
            }
        }
    });
}

   
function launchEditEvent(eventIndex){
    state.eventIndex = eventIndex; //if null means it's a new event to be added
    formatMidscreen("editEvent");
    document.getElementById("eventAssemblyName").innerText = state.priorAssemblyName;
    document.getElementById("myListbox").style.visibility='visible';
    
    if (eventIndex == null) setEventFields("","","","");
    else {
        let ev = bmhc.getDereferencedEvent(state.priorAssemblyName,eventIndex);
        setEventFields(ev.date, ev.verb, ev.object, ev.comment);
    }
}

function setEventFields(date,verb,obj,comment){
    document.getElementById("eventDate").value = date;
    document.getElementById("eventVerb").value = verb;
    document.getElementById("eventObject").value = obj;
    document.getElementById("eventComment").value = comment;
    handleVerbChange(verb);
}
    
function checkAndSaveEvent(){
    let date = document.getElementById("eventDate").value.trim();
    let verb = document.getElementById("eventVerb").value.trim();
    let obj  = document.getElementById("eventObject").value.trim();
    let comment = document.getElementById("eventComment").value.trim();
    
    const result = bmhc.setEvent(state.priorAssemblyName, state.eventIndex, date,verb,obj,comment);
    if (result == 'ok') { 
        
        makeLIsOfArray(bmhc.getEventStrings(state.priorAssemblyName)); //so listBox reflects changes
        if (verb == 'set-membership'){ 
            let temp = date;
            date = bmhc.yearLater(state.oldSetmMembershipDate,date);
            state.oldSetMembershipDate = temp;
        }
        else {date = ''; verb = ''; state.oldSetMembershipDate = null;} 
        setEventFields(date, verb,'',''); //and stay put, ready to add another of same verb (helps for set-membership)
        state.eventIndex = null; //clear eventIndex, so don't delete another one next time!
        
    } else  alert(result); //and do nothing, stay put
}


function loadData(){
    //bmhc.loadDB();
    initAssemblyViewer();
}

function makeTextFile(text) {
    let data = new Blob([text], {type: 'text/plain'});

    // If we are replacing a previously generated file we need to
    // manually revoke the object URL to avoid memory leaks.
    if (state.textFile !== null) window.URL.revokeObjectURL(state.textFile);

    state.textFile = window.URL.createObjectURL(data);

    return state.textFile;
};


function saveData(){
    let link = document.getElementById('downloadlink');
    link.href = makeTextFile(bmhc.wrapInJS(bmhc.getData())); 
    link.style.visibility = 'visible'; //turn it on so user can accept/reject download to HD.
}

function makeMeDisappear(that){
    that.style.visibility = 'hidden';
    return true; //so that default behavior, saveing the file, is done.
}
    
function ultest(){
    var ul = document.getElementById('selectList');
    ul.onclick = function(event) {
        alert(event.target.innerText, event.target.value);
    };
}
 
//state
//   checkbox 0: assemblies that are neither B nor M, 1 B, 2 M, 3 both
//   whichList "assemblies" or "events"
//   priorAssemblyName target of event editing
//   eventIndex index of event being edited or deleted, valid only after a getEventList
//   hasn't been invalidated by a deleteEvent or setEvent (in which case, just need to redo getEventList).
let state = {checkbox:1, whichList:"assemblies", priorAssemblyName:"", eventIndex:null, textFile:null, oldSetMembershipDate:null};

let bmhc =  BMHCobj(); 
bmhc.setData(bmhcData());
bmhc.setTags(bmhcTags());
    
window.onclick = function(event) {
  var modals = document.getElementsByClassName("modal");
  if (event.target == modals[0]) {
      console.log("window.onclick", modals);
    if (state.whichList=="assemblies" ) initAssemblyViewer();
    else if (state.whichList=="events") initEventViewer();
  }
}
    
installEventListeners();
initEventTagObjectHTML(); initVerbHTML();
initAssemblyViewer();
    

</script>

</body>